# Подготовка к рубежной работе по РСХД

## Архитектура PostgreSQL

### ANSI-SPARC

Это трёхуровневая модель архитектуры СУБД:

1. Внешний (пользовательский) уровень
2. Промежуточный (концептуальный) уровень
3. Внутренний (физический) уровень

PostgreSQL, как и все современные СУБД, следует этой модели.

### Архитектура СУБД

#### Процессы СУБД

- `postmaster`: представляет сервер PostgreSQL. Отвечает за запуск/остановку,
  создаёт серверные процессы (_postgres_) для обработки соединений, управляет
  данными одного кластера бд
- `postgres`: обрабатывает конкретное клиентское соединение
- `checkpointer`: создаёт контрольные точки - синхронизация WAL с диском, запись
  "грязных" страниц на диск, фиксация в логах.
- `background writer`: записывает изменённые страницы из SB (shared buffers) на
  диск в файлы данных
- `WAL writer`: записывает записи WAL буфера на диск
- `archiver`: копирует WAL файлы в указанное место
- `logging collector`: stderr -> логи
- `stats collector`: собирает статистику в промежуточные файлы для использования
  другими процессами -> pg*stat*\*

#### Разделяемая память PostgreSQL

Это сегмент RAM, доступный всем процессам PostgreSQL. Он используется для
различных буферов:

- `Shared buffers` (разделяемое буферное _пространство_) - Настраивается через
  _shared_buffers_, 128 MB по умолчанию. Хранит копии страниц (блоков данных),
  считанных из файлов данных.
- `WAL buffers` - буфер, работающий на уровне кластера бд, обеспечивающий
  Durability. Подробнее далее.
- `CLOG buffers` - Commit LOG, буфер для хранения данных о статусе проведения
  транзакций.
- `Lock space` - буфер для хранения данных о блокировках, использующихся
  экземпляром БД.

### WAL

WAL (Write Ahead Log) - техология обеспечения сохранности данных при сбоях.

По сути это буфер, работающий на уровне кластера бд, в который записываются все
изменения. Транзакция считается зафиксированной после сохранения WAL-записей на
диск с помощью системного вызова `fsync()` для гарантии того, что данные
действительно записаны на диск, а не лежат в кэше ОС.

#### Принцип работы

Каждой записи (т.е. каждому изменению) присваивается свой **LSN**. WAL буферы
хранятся в разделяемой памяти. Процесс WAL writer записывает эти буферы на диск.
При сбое система может восстановить изменения по WAL.

#### LSN (Log Sequence Number)

Это указатель на запись в WAL-журнале. Прерставляет собой 64-битное число.

#### Контрольная точка (checkpoint)

Точка в последовательности транзакций, в которую произведена синхронизация
результатов выполненных операций с файлами на диске.

Создаётся процессом `checkpointer` в двух случаях:

1. Заполнен WAL буфер (`max_wal_size`)
2. Через время `checkpoint_timeout` (дефолт 300с.)

#### Восстановление после сбоев

### Файловая структура

#### PGDATA

#### Структура директорий

#### Табличные пространства

## Кластер, БД, Схема, Таблица

### Иерархия объектов

- кластер бд
- бд
- схема
- таблица

### Табличные пространства

### Конфигурация

- postgresql.conf
- pg_hba.conf
- Динамические параметры

### Конфигурационные утилиты (управление сервером)

- pg_ctl
- pg_reload_conf()

## Системный каталог и метаданные

### Системные таблицы

- pg_class
- pg_attribute
- pg_database
- pg_roles

### Information schema

- стандартный интерфейс к метаданным
- отличие от системных каталогов

### OID, filenode

- как находить объекты по OID
- связь OID и фс

## Транзакции

### ACID

Это набор свойств, гарантирующих надёжную обработку транзакций.

1. **A**tomicity (Атомарность == **неделимость**): Транзакция выполняется
   полностью, либо не выполняется вообще.
2. **C**onsistency (Согласованность): Транзакция переводит БД из одного
   согласованного состояния в другое.
3. **I**solation (Изолированность): Конкурентно выполняющиеся транзакции
   изолированы друг от друга.
4. **D**urability (Долговечность): Результаты зафиксированной транзакции
   сохраняются даже при сбоях системы.

### Управление транзакциями

```sql
-- Начало транзакции
BEGIN; -- или START TRANSACTION;

-- Фиксация изменений (сохранение)
COMMIT;

-- Отмена изменений
ROLLBACK;

-- Создание точки сохранения внутри транзакции
SAVEPOINT имя_точки;

-- Откат к точке сохранения
ROLLBACK TO имя_точки;
```

### Идентификация транзакций (xid)

### MVCC (SSI)

### Уровни изоляции

1. Read Uncommiteted (не поддерживается psql)
2. Read Committed
3. Repeatable Read
4. Serializable

### VACUUM

- Принцип работы
- VACUUM vs VACUUM FULL
- avtovacuum

## Роли и привилегии

### Управление пользователями

### Группы ролей

### Объектные привилегии

## Практика SQL

### Создание/изменение объектов

### Управление привилегиями

### Запросы к системному каталогу

# Разбор прошлогоднего варианта

1. Setup THE EXACT evironment presented here:

| ![img](../docs/old-frontier.jpg) |
| -------------------------------- |

2. Run sql scripts, check behaviour, play around, research, memorize sql.
